#!/bin/bash
modopt="$1"
main="$2"
lto="$3"
shift; shift; shift
LIBDIR="$(dirname "$0")"/../lib/kllvm/
if [ "$main" = "main" ]; then
  MAINFILES="$LIBDIR"/llvm/main/main.ll
else
  MAINFILES=""
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
  flags="-lncurses -L/usr/local/opt/libffi/lib"
else
  flags=-ltinfo
fi

if [ "$lto" = "lto" ]; then
  flags="$flags -flto -Wl,-mllvm,-tailcallopt"
  files=("$LIBDIR"/llvm/*.ll)
else
  files=()
  modasm="$(mktemp tmp.XXXXXXXXXX.s)"
  trap "rm -f $modasm" INT TERM EXIT
  @LLC@ -tailcallopt "$modopt" -O0 -o "$modasm"
  modopt="$modasm"
  for file in "$LIBDIR"/llvm/*.ll; do
    tmp="$(mktemp tmp.XXXXXXXXXX.s)"
    @LLC@ -tailcallopt "$file" -o "$tmp"
    files+=("$tmp")
  done
fi

@CMAKE_CXX_COMPILER@ -Wno-override-module "$modopt" "${files[@]}" \
  "$LIBDIR"/libarithmetic.a \
  "$MAINFILES" \
  "$LIBDIR"/libconfigurationparser.a \
  "$LIBDIR"/libstrings.a \
  "$LIBDIR"/libio.a \
  "$LIBDIR"/rust/libdatastructures.rlib \
  "$LIBDIR"/rust/deps/libim_rc-*.rlib \
  "$LIBDIR"/rust/deps/liblibc-*.rlib \
  "$LIBDIR"/rust/deps/libsized_chunks-*.rlib \
  "$LIBDIR"/rust/deps/libtypenum-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/libstd-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/libcore-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/liballoc-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/libunwind-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/libcompiler_builtins-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/libpanic_abort-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/libbacktrace_sys-*.rlib \
  "$LIBDIR"/rust/deps/stdlib/librustc_demangle-*.rlib \
  "$LIBDIR"/libParser.a \
  "$LIBDIR"/libAST.a \
  "$LIBDIR"/liballoc.a \
  "$LIBDIR"/libmeta.a \
  -lgmp -lmpfr -lpthread -ldl -lffi \
  $flags \
  -ljemalloc \
  -I "$(dirname "$0")"/../include \
  "$@"
