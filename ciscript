#!/bin/bash -ex
export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH

if [[ "$OSTYPE" == "darwin"* ]]; then
    export PATH="/usr/local/opt/flex/bin:/usr/local/opt/llvm@6/bin:$PATH"
    export LDFLAGS="-L/usr/local/opt/bison/lib -L/usr/local/opt/llvm@6/lib -L/usr/local/opt/flex/lib"
    export CPPFLAGS="-I/usr/local/opt/llvm@6/include -I/usr/local/opt/flex/include"
    export PATH="/usr/local/opt/bison/bin:$PATH"
    export FLEX_EXECUTABLE="/usr/local/opt/flex/bin/flex"
    export BISON_EXECUTABLE="/usr/local/opt/bison/bin/bison"
fi

mkdir -p build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make -j`nproc`
make run-unittests
cd ../runtime/datastructures
cargo test
cd ../../matching
mvn verify -U
cd ../build

export PATH="`pwd`/install/bin:`pwd`/bin:$PATH"
make install

cp ../test/Makefile ./TestMakefile

make -f TestMakefile

diff io_output1.txt ../test/ioTest1.out
diff `ls | grep io_log` ../test/ioTest3.out
rm `ls | grep io_log`


# rm -f configparser configparser.ll interpreter
rm -f configparser configparser.ll
